select 
so.company as "Clinic",
monthname(so.transaction_date) as "20 Days Of",
year(so.transaction_date) as "Year",
count(case when so.order_type = "Retail Sales" and so.lead_type="Fresh Order" then 0 end) as "Retail New Order Count",
SUM(case when so.order_type = "Retail Sales" and so.lead_type="Fresh Order" then rounded_total else 0 end)  as "Retail New Sales:Currency",

count(case when so.order_type = "Retail Sales" and so.lead_type="Existing Customer Order" then 0 end) as "Retail Old Order Count",
SUM(case when so.order_type = "Retail Sales" and so.lead_type="Existing Customer Order" then rounded_total else 0 end) as "Retail Old Sales:Currency",

count(case when so.order_type = "Sales" and so.lead_type="Fresh Order" then 0 end) as "COD New Order Count",
SUM(case when so.order_type = "Sales" and so.lead_type="Fresh Order" then rounded_total else 0 end) as "COD New Sales:Currency",

count(case when so.order_type = "Sales" and so.lead_type="Existing Customer Order" then 0 end)  as "COD Old Order Count",
SUM(case when so.order_type = "Sales" and so.lead_type="Existing Customer Order" then rounded_total else 0 end) as "COD Old Sales:Currency",

count(case when so.order_type = "Retail Sales" and so.lead_type="Fresh Order" then 0 end) + count(case when so.order_type = "Retail Sales" and so.lead_type="Existing Customer Order" then 0 end) +count(case when so.order_type = "Sales" and so.lead_type="Fresh Order" then 0 end) + count(case when so.order_type = "Sales" and so.lead_type="Existing Customer Order" then 0 end) as "Total Count" ,

SUM(case when so.order_type = "Retail Sales" and so.lead_type="Fresh Order" then rounded_total else 0 end) +SUM(case when so.order_type = "Retail Sales" and so.lead_type="Existing Customer Order" then rounded_total else 0 end) + SUM(case when so.order_type = "Sales" and so.lead_type="Fresh Order" then rounded_total else 0 end) + SUM(case when so.order_type = "Sales" and so.lead_type="Existing Customer Order" then rounded_total else 0 end) as "Total sales Amount:Currency"

from (select company,transaction_date,order_type,lead_type,rounded_total from `tabSales Order`) so
where  date(so.transaction_date) between %(from_date)s and %(to_date)s
and day(so.transaction_date) between 1 and 20 and (select case when %(clinic)s ="__ALL__" then 1=1 else so.company=%(clinic)s end)
 
group by so.company, year(so.transaction_date),month(so.transaction_date)
order by  year(so.transaction_date) desc,month(so.transaction_date) desc,so.company